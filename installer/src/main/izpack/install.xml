<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<installation version="5.0">
  <info>
    <appname>Orchestra</appname>
    <appversion>4.8</appversion>
    <url>http://orchestra.soffico.de/en/start-2/</url>    
    <authors>
        <author name="soffico GmbH" email="info(at)soffico.de"/>
    </authors>
    <javaversion>1.7</javaversion>
    <requiresjdk>yes</requiresjdk>
  </info>
  <guiprefs width="650" height="480" resizable="no">
    <modifier key="useLabelIcons" value="no"/>
    <modifier key="useHeadingPanel" value="yes"/>
    <modifier key="headingLineCount" value="1"/>
    <modifier key="headingFontSize" value="1.5"/>
    <modifier key="useFlags" value="no"/>
    <modifier key="langDisplayType" value="native"/>
    <modifier key="allYGap" value="8"/>
    <modifier key="allXGap" value="4"/>
    <modifier key="labelGap" value="2"/>
    <modifier key="layoutAnchor" value="NORTHWEST"/>
    <modifier key="headingPanelCounter" value="progressbar"/>
    <modifier key="headingPanelCounterPos" value="inNavigationPanel"/>

    <!-- Show the splashScreen for a minimum of 1000 milliseconds -->   
    <modifier key="useSplashScreen" value="1000"/>   
  </guiprefs>

  <locale>
    <langpack iso3="eng"/>
    <langpack iso3="deu"/>
  </locale>

  <natives>
   <native type="izpack" name="ShellLink.dll" stage="both">
     <os family="windows" />
   </native>
   <native type="izpack" name="ShellLink_x64.dll" stage="both">
     <os family="windows" />
    </native>
  </natives>

  <dynamicvariables>


    <variable name="INSTALL" value="$INSTALL_PATH">
      <filters>
        <regex regexp="[/\\]+" replace="/" global="true" />
      </filters>
    </variable>

    <variable name="TOMCAT_HOME" value="${tomcat.home}"/>

    <variable name="CONNECTOR_TYPE" value="${connector.type}"/>

    <variable name="JDKPathPanel.minVersion" value="1.6"/>
    <variable name="JDKPathPanel.maxVersion" value="1.8"/>
    <variable name="JDKPathPanel.skipIfValid" value="yes"/>
    <variable name="ORC_JAVA_HOME" value="$JAVA_HOME"/>

    <!-- 
      These two line are used to prevent error occured by user selected jdk package
      that is not match with the path in environment variable. In both case,
      it will eventually use the one in path environment
    -->
    <!-- JavaHome exists, JDK_PATH will have value of JAVA_HOME -->
    <variable name="JRE_PATH" value="$JAVA_HOME" condition="!isEmptyJavaHome"/>
    <!-- JavaHome is empty, JDK_PATH will have value of jdkPath specified by user -->
    <variable name="JRE_PATH" value="$jdkPath\jre" condition="isEmptyJavaHome"/>


    <variable name="GEN_RET" value="return" />
    <variable name="USERNAME" value="${dbUserName}" />
    <variable name="PASSWORD" value="${dbPassword}" />
    <variable name="SERVER_NAME" value="${server.name}" />
    <variable name="SERVER_START_PORT" value="${server.start.port}" />
    <variable name="SERVER_SHUTDOWN_PORT" value="${server.shutdown.port}" />
    <variable name="DATABASE_NAME" value="${db.name}" />

    <!-- 
      This is only for SQL, TODO: MUST DO LIKE THIS WITH OTHER DATABASE TYPE 
      Also this is too simple, can improve by using condition variable to set flag
    -->
    <!-- SQL CONNECTOR -->
    <variable name="CONNECTOR_NAME" value="mysql" condition="condition.mysql"/>
    <variable name="JDBC_URL" value="${jdbcURL}" condition="condition.mysql"/>
    <variable name="JDBC_DRIVER" value="${jdbcDriver}" condition="condition.mysql"/>
    

    <variable name="FILENAME" value="${filename}" condition="condition.mysql"/>
    <variable name="OS_MULTIPLIER" value="10" condition="condition.mysql"/>  
    <!-- SQL, set other connectors enable flag to false -->
    <variable name="DB_ORACLE" value="false" condition="condition.mysql"/>  
    <variable name="DB_DB2" value="false" condition="condition.mysql"/>  
    <variable name="DB_MYSQL" value="true" condition="condition.mysql"/>  
    <variable name="DB_MSSQL" value="false" condition="condition.mysql"/>  


    <!-- DB_ORACLE -->
    <variable name="CONNECTOR_NAME" value="oracle" condition="condition.oracle"/>
    <!-- ORACLE, set other connectors enable flag to false -->
    <variable name="DB_ORACLE" value="true" condition="condition.oracle"/>  
    <variable name="DB_DB2" value="false" condition="condition.oracle"/>  
    <variable name="DB_MYSQL" value="false" condition="condition.oracle"/>  
    <variable name="DB_MSSQL" value="false" condition="condition.oracle"/> 

    <!-- PACKAGE SELECTION -->
    <variable name="PACK_DESIGNER" value="${pack.designer}" />  
    <variable name="PACK_RUNTIME" value="${pack.runtime}" />  

  </dynamicvariables>

  <conditions>
    <condition type="empty" id="isEmptyJavaHome">
      <variable>ORC_JAVA_HOME</variable>
    </condition>


    <condition type="variable" id="condition.oracle">
      <name>connector.type</name>
      <value>oracle</value>
    </condition>

    <condition type="variable" id="condition.db2">
      <name>connector.type</name>
      <value>db2</value>
    </condition>

    <!-- If connecter.type == SQL, condition.sql will be true, all of SQL CONNECTOR variable will be assigned value -->
    <condition type="variable" id="condition.mysql">
      <name>connector.type</name>
      <value>mysql</value>
    </condition>

    <condition type="variable" id="condition.sqlserver">
      <name>connector.type</name>
      <value>sqlserver</value>
    </condition>

    <panelcondition panelid="jdk.path.panel" conditionid="!isEmptyJavaHome" />
  </conditions>

  <resources>
    <res src="pack_designer/Licenses/JGoodies_License.txt"  id="LicencePanel.licence_eng" />
    <res src="ProcessPanel.Spec.xml"                        id="ProcessPanel.Spec.xml"/>
    <res src="Win_shortcutSpec.xml"                         id="Win_shortcutSpec.xml"/>
    <res src="Unix_shortcutSpec.xml"                        id="Unix_shortcutSpec.xml"/>
    <res src="UserInput.Spec.xml"                           id="userInputSpec.xml"/>
    <res src="emds_logo.png"                                id="Heading.image" />
    <res src="i18n/CustomLangPack.xml_eng"                  id="CustomLangPack.xml_eng"/>
    <res src="i18n/CustomLangPack.xml_deu"                  id="CustomLangPack.xml_deu"/>

    <res src="emds_logo_v2.png"                             id="installer.langsel.img"/>
    <!--Define the splash screen image as a reading just like a heading image -->
    <res src="emds_logo_v2.png"                             id="Splash.image" />
  </resources>

  <jar src="orchestra.jar" stage="install"/>

  <panels>
    <panel classname="HelloPanel"/>

    <panel classname="com.izforge.izpack.panels.mypanels.MyHelloPanel" id="myHello"/>

    <!-- this is our custom panel, loaded from the izpack-panels.jar file -->    
    <!-- 
    <panel classname="com.izforge.izpack.panels.mypanels.MyHelloPanel" id="myHello"/>
    -->
    <panel classname="LicencePanel"   id="LicencePanel.licence_eng" />
    <panel classname="TargetPanel" />
    <panel classname="JDKPathPanel"   id="jdk.path.panel"/>
    <panel classname="PacksPanel"/>
    <panel classname="UserInputPanel" id="Tomcat.Conf"/>
    <panel classname="UserInputPanel" id="Connector.Select"/>
    <panel classname="UserInputPanel" id="Connector.Sql.Conf"/>
    <panel classname="InstallPanel"/>
    <panel classname="ProcessPanel"/>
    <panel classname="ShortcutPanel"/>
    <panel classname="SimpleFinishPanel"/>
  </panels>

  

  <packs>
    <pack name="Orchestra Core" preselected="yes" required="yes" variable="pack.designer">
      <description>Orchestra Core : Include Orchestra Designer </description>
      <fileset dir="pack_designer" targetdir="$INSTALL_PATH/"/>

      <!-- For Windows: Modify orchestra_env.bat -->
      <file targetdir="$INSTALL_PATH/Startscripts/Windows" src="pack_designer/Startscripts/Windows/orchestra_env.bat"/>
      <parsable type="shell" targetfile="$INSTALL_PATH/Startscripts/Windows/orchestra_env.bat" parse="yes"/>

      <!-- For Unix: Modify orchestra_env.sh -->
      <file targetdir="$INSTALL_PATH/Startscripts/Unix" src="pack_designer/Startscripts/Unix/orchestra_env.sh"/>
      <parsable type="shell" targetfile="$INSTALL_PATH/Startscripts/Unix/orchestra_env.sh" parse="yes"/>

      <!-- Mark as executable file after the installation, fix permission denied issue in Unix system -->
      <executable targetfile="$INSTALL_PATH/Startscripts/Unix/designer.sh" os="unix" stage="never" failure="warn" keep="true" />

      <file override="true" targetdir="$INSTALL_PATH/Application/orchestra/WEB-INF/classes/config/" src="pack_designer/Application/orchestra/WEB-INF/classes/config/environment_settings.xml"/>
      <parsable type="shell" targetfile="$INSTALL_PATH/Application/orchestra/WEB-INF/classes/config/environment_settings.xml" parse="yes"/>  
    </pack>

    <pack name="Orchestra Runtime" preselected="yes" required="no" variable="pack.runtime">
      <description>Connect with Database</description>


      <fileset dir="pack_runtime" targetdir="$INSTALL_PATH/"/>

      <!-- No Flyway : MySQL configuration -->
      <parsable type="shell" targetfile="$INSTALL_PATH/Database/Scripts/MySQL/mysql_install_all.sql" parse="yes"/>

      <!-- Flyway Configuration -->
      <parsable type="shell" targetfile="$INSTALL_PATH/Database/orchestra-db/pom.xml" parse="yes"/>

      <!-- ///////////////////////////////////////////////////////////////////////// -->

      <file src="orchestra.zip" targetdir="$TOMCAT_HOME/webapps" unpack="true" override="true" />

      <file override="true" targetdir="$TOMCAT_HOME/webapps/orchestra/WEB-INF/classes/config/" src="pack_designer/Application/orchestra/WEB-INF/classes/config/environment_settings.xml"/>
      

      <parsable type="shell" targetfile="$TOMCAT_HOME/webapps/orchestra/WEB-INF/classes/config/environment_settings.xml" parse="yes"/>
      <parsable type="shell" targetfile="$TOMCAT_HOME/webapps/orchestra/WEB-INF/classes/logging.properties" parse="yes"/>
      
      <!-- Tomcat Configuration in Unix -->
      <file override="true" targetdir="$TOMCAT_HOME/bin/" src="setenv.sh">
        <os family="unix" />
      </file>
      <parsable type="shell" targetfile="$TOMCAT_HOME/bin/setenv.sh" parse="yes" >
        <os family="unix" />
      </parsable>
    
    </pack>
  </packs>
  

</installation>
